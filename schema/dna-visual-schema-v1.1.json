{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.org/schema/dna-visual-schema-v1.1.json",
  "title": "DNA/RNA/Protein Visual Grammar Schema",
  "description": "Schema v1.1 for A4-oriented biological pathway diagrams with node/edge grammar.",
  "type": "object",
  "additionalProperties": false,
  "required": ["nodes", "edges"],
  "properties": {
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "specVersion",
        "generatedAt",
        "lang",
        "topic",
        "view",
        "theme"
      ],
      "properties": {
        "specVersion": {
          "type": "string",
          "enum": ["1.1"]
        },
        "generatedAt": {
          "type": "string",
          "format": "date-time"
        },
        "lang": {
          "type": "string",
          "description": "Rendering technology or runtime, e.g. HTML, React, Canvas."
        },
        "topic": {
          "type": "string",
          "description": "Diagram focus, e.g. Transcription initiation (Pol II, +1 TSS)."
        },
        "org": {
          "type": "string",
          "enum": ["eukaryote", "prokaryote", "virus"],
          "default": "eukaryote"
        },
        "level": {
          "type": "string",
          "enum": ["basic", "standard", "advanced"],
          "default": "standard"
        },
        "view": {
          "type": "string",
          "enum": ["process", "structure", "pathway", "timeline"]
        },
        "theme": {
          "type": "string",
          "enum": ["light", "dark", "print"],
          "default": "light"
        },
        "layout": {
          "type": "string",
          "enum": ["A4-portrait", "A4-landscape"],
          "default": "A4-landscape"
        },
        "exports": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["svg", "png", "pdf"]
          },
          "uniqueItems": true,
          "default": ["svg", "png"]
        },
        "interactive": {
          "type": "boolean",
          "default": false
        },
        "scale": {
          "type": "number",
          "minimum": 0.5,
          "maximum": 4
        },
        "grid": {
          "type": "boolean",
          "default": false
        },
        "checksum": {
          "type": "string",
          "description": "Optional checksum for exported bundle."
        }
      }
    },
    "legend": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "sections": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["title", "items"],
            "properties": {
              "title": {"type": "string"},
              "items": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["label"],
                  "properties": {
                    "label": {"type": "string"},
                    "icon": {"type": "string"},
                    "description": {"type": "string"}
                  }
                }
              }
            }
          }
        }
      }
    },
    "preset": {
      "type": "string",
      "description": "Active preset identifier used for localized export."
    },
    "org": {
      "type": "string",
      "description": "Active organism key used for localized export."
    },
    "nodes": {
      "type": "array",
      "minItems": 1,
      "items": {"$ref": "#/definitions/node"},
      "uniqueItems": true
    },
    "edges": {
      "type": "array",
      "minItems": 0,
      "items": {"$ref": "#/definitions/edge"},
      "uniqueItems": true
    },
    "transform": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "scale": {"type": "number", "minimum": 0},
        "pan": {
          "anyOf": [
            {"$ref": "#/definitions/point"},
            {"type": "null"}
          ]
        }
      }
    },
    "preferences": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "gridVisible": {"type": "boolean"},
        "gridSnap": {"type": "boolean"}
      }
    }
  },
  "definitions": {
    "point": {
      "type": "object",
      "required": ["x", "y"],
      "properties": {
        "x": {"type": "number"},
        "y": {"type": "number"}
      }
    },
    "bounds": {
      "type": "object",
      "required": ["x", "y", "w", "h"],
      "properties": {
        "x": {"type": "number"},
        "y": {"type": "number"},
        "w": {"type": "number", "minimum": 0},
        "h": {"type": "number", "minimum": 0}
      }
    },
    "label": {
      "type": "object",
      "required": ["text"],
      "properties": {
        "text": {"type": "string"},
        "anchor": {
          "type": "string",
          "enum": ["center", "north", "south", "east", "west", "auto"],
          "default": "auto"
        },
        "fontSize": {
          "type": "number",
          "minimum": 12,
          "description": "Minimum readable font size in px"
        },
        "orientation": {
          "type": "string",
          "enum": ["horizontal", "vertical", "diagonal"]
        }
      }
    },
    "frame": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["genomic", "transcript", "protein", "regulatory", "interaction", "custom"]
        },
        "assembly": {"type": "string"},
        "chromosome": {"type": "string"},
        "locus": {"type": "string"},
        "reference": {"type": "string"},
        "notes": {"type": "string"}
      }
    },
    "coordinateSpan": {
      "type": "object",
      "required": ["start", "end"],
      "additionalProperties": false,
      "properties": {
        "start": {"type": "number"},
        "end": {"type": "number"},
        "unit": {"type": "string", "default": "bp"},
        "reference": {"type": "string"},
        "confidence": {"type": "number", "minimum": 0, "maximum": 1}
      }
    },
    "strand": {
      "type": "string",
      "enum": ["plus", "minus", "bidirectional", "unknown", "both"]
    },
    "recognitionSite": {
      "type": "object",
      "required": ["name", "start", "end"],
      "additionalProperties": false,
      "properties": {
        "name": {"type": "string"},
        "start": {"type": "number"},
        "end": {"type": "number"},
        "sequence": {"type": "string"},
        "strand": {
          "type": "string",
          "enum": ["plus", "minus", "bidirectional", "unknown", "both"],
          "default": "plus"
        },
        "evidence": {"type": "string"},
        "notes": {"type": "string"}
      }
    },
    "timeline": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "phase": {"type": "string"},
        "order": {"type": "number"},
        "start": {"type": "number"},
        "end": {"type": "number"},
        "unit": {"type": "string"}
      }
    },
    "stringList": {
      "type": "array",
      "items": {"type": "string"}
    },
    "markers": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "start": {
          "type": "string",
          "enum": ["arrow-flow", "arrow-regulation", "tee-regulation"]
        },
        "end": {
          "type": "string",
          "enum": ["arrow-flow", "arrow-regulation", "tee-regulation"]
        }
      }
    },
    "node": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type", "x", "y", "width", "height"],
      "properties": {
        "id": {"type": "string"},
        "label": {"type": "string"},
        "type": {"type": "string"},
        "layer": {
          "type": "string",
          "enum": ["chromatin", "factors", "rna", "annotations"]
        },
        "x": {"type": "number"},
        "y": {"type": "number"},
        "width": {"type": "number", "minimum": 0},
        "height": {"type": "number", "minimum": 0},
        "z": {"type": "number"},
        "notes": {
          "type": "array",
          "items": {"type": "string"}
        },
        "autoCorrections": {
          "type": "array",
          "items": {"type": "string"}
        },
        "frame": {
          "anyOf": [
            {"$ref": "#/definitions/frame"},
            {"type": "null"}
          ]
        },
        "coordinates": {
          "anyOf": [
            {"$ref": "#/definitions/coordinateSpan"},
            {"type": "null"}
          ]
        },
        "strand": {
          "anyOf": [
            {"$ref": "#/definitions/strand"},
            {"type": "null"}
          ]
        },
        "recognitionSites": {
          "type": "array",
          "items": {"$ref": "#/definitions/recognitionSite"}
        },
        "aliases": {"$ref": "#/definitions/stringList"},
        "timeline": {
          "anyOf": [
            {"$ref": "#/definitions/timeline"},
            {"type": "null"}
          ]
        },
        "evidence": {"$ref": "#/definitions/stringList"},
        "references": {
          "type": "array",
          "items": {"type": "string"}
        },
        "confidence": {"type": "number", "minimum": 0, "maximum": 1}
      }
    },
    "edge": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "from", "to", "kind"],
      "properties": {
        "id": {"type": "string"},
        "from": {"type": "string"},
        "to": {"type": "string"},
        "kind": {
          "type": "string",
          "enum": ["flow", "regulation"]
        },
        "router": {
          "type": "string",
          "enum": ["orthogonal", "direct", "straight", "bezier"]
        },
        "label": {"type": "string"},
        "markers": {
          "anyOf": [
            {"$ref": "#/definitions/markers"},
            {"type": "null"}
          ]
        },
        "autoCorrections": {
          "type": "array",
          "items": {"type": "string"}
        },
        "frame": {
          "anyOf": [
            {"$ref": "#/definitions/frame"},
            {"type": "null"}
          ]
        },
        "coordinates": {
          "anyOf": [
            {"$ref": "#/definitions/coordinateSpan"},
            {"type": "null"}
          ]
        },
        "strand": {
          "anyOf": [
            {"$ref": "#/definitions/strand"},
            {"type": "null"}
          ]
        },
        "recognitionSites": {
          "type": "array",
          "items": {"$ref": "#/definitions/recognitionSite"}
        },
        "timeline": {
          "anyOf": [
            {"$ref": "#/definitions/timeline"},
            {"type": "null"}
          ]
        },
        "evidence": {"$ref": "#/definitions/stringList"},
        "references": {
          "type": "array",
          "items": {"type": "string"}
        },
        "confidence": {"type": "number", "minimum": 0, "maximum": 1}
      }
    }
  }
}
